import os
import subprocess
import threading
import time
import signal
import requests
import hashlib
from flask import Flask, render_template, send_from_directory, abort, request, redirect, url_for, flash
from flask_cors import CORS
from collections import deque # ржнрж┐ржбрж┐ржУ ржХрж┐ржЙрзЯрзЗрж░ ржЬржирзНржп

# --- ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ---
DEFAULT_VIDEO_URL = "https://www.dropbox.com/scl/fi/2w5ai1fda804zfruoj8yn/assets_staytuned0.ts?rlkey=jixrs4b1v3keu4q6hpebmbw5v&st=b1teebao&raw=1"
DEFAULT_VIDEO_FILENAME = "default_video.ts" # ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржЬржирзНржп ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржирж╛ржо

VIDEO_DIR = "videos" # ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржнрж┐ржбрж┐ржУржЧрзБрж▓рзЛ ржПржЦрж╛ржирзЗ ржерж╛ржХржмрзЗ
STREAM_OUTPUT_DIR = "stream_output" # HLS ржЖржЙржЯржкрзБржЯ ржПржЦрж╛ржирзЗ рждрзИрж░рж┐ рж╣ржмрзЗ
# FFMPEG_SINGLE_INPUT_FILE = "current_input.mp4" # ржЖрж░ ржмрзНржпржмрж╣рзГржд рж╣ржЪрзНржЫрзЗ ржирж╛
FFMPEG_PLAYLIST_FILE = "playlist.txt" # ржПржЗ ржлрж╛ржЗрж▓рзЗ ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУрж░ ржкрж╛рже ржерж╛ржХржмрзЗ, ржХрж┐ржирзНрждрзБ FFmpeg ржХржорж╛ржирзНржбрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржкрж╛рже ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
HLS_OUTPUT_FILE = os.path.join(STREAM_OUTPUT_DIR, "stream.m3u8")

# ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐рзЯрзЗржмрж▓
video_queue = deque() # ржЕрзНржпрж╛ржбржорж┐ржи ржжрзНржмрж╛рж░рж╛ ржпрзЛржЧ ржХрж░рж╛ ржнрж┐ржбрж┐ржУ URL-ржПрж░ ржХрж┐ржЙ
played_today = set() # ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ ржнрж┐ржбрж┐ржУрж░ URL ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рж╛рж░ ржЬржирзНржп (ржЕрзНржпрж╛ржк рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ рж╣рж▓рзЗ рж░рж┐рж╕рзЗржЯ рж╣ржмрзЗ)
current_ffmpeg_process = None
stop_event = threading.Event() # ржерзНрж░рзЗржб ржУ FFmpeg ржмржирзНржз ржХрж░рж╛рж░ ржЬржирзНржп
stream_lock = threading.Lock() # ржХрж┐ржЙ ржПржмржВ FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛ржЗржЬ ржХрж░рж╛рж░ ржЬржирзНржп
currently_playing_url = None # ржмрж░рзНрждржорж╛ржирзЗ ржХрзЛржи URL ржЯрж┐ ржкрзНрж▓рзЗ рж╣ржЪрзНржЫрзЗ ржмрж╛ ржкрзНрж▓рзЗ рж╣ржУрзЯрж╛рж░ ржЬржирзНржп ржкрзНрж░рж╕рзНрждрзБржд
default_video_path = None # ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржкрж╛рже

app = Flask(__name__)
CORS(app) # рж╕ржм рж░рзБржЯрзЗрж░ ржЬржирзНржп CORS рж╕ржХрзНрж░рж┐рзЯ ржХрж░рж╛
app.secret_key = os.urandom(24) # flash ржмрж╛рж░рзНрждрж╛рж░ ржЬржирзНржп Secret Key

# --- ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐ ---
os.makedirs(VIDEO_DIR, exist_ok=True)
os.makedirs(STREAM_OUTPUT_DIR, exist_ok=True)

# --- Helper Functions ---

def get_safe_filename(url):
    """URL ржерзЗржХрзЗ ржПржХржЯрж┐ ржирж┐рж░рж╛ржкржж ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо рждрзИрж░рж┐ ржХрж░рзЗ (рж╣рзНржпрж╛рж╢ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)"""
    hashed_url = hashlib.sha1(url.encode()).hexdigest()[:10] # URL ржПрж░ рж╣рзНржпрж╛рж╢
    # ржлрж╛ржЗрж▓рзЗрж░ ржПржХрзНрж╕ржЯрзЗржирж╢ржи ржЕржирзБржорж╛ржи ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ (рж╕рж░рж▓ ржкржжрзНржзрждрж┐)
    try:
        base_name = os.path.basename(url.split('?')[0]) # Query string ржмрж╛ржж ржжрж┐рзЯрзЗ ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо ржирж┐ржи
        _, ext = os.path.splitext(base_name)
        if not ext or len(ext) > 5: # ржпржжрж┐ ржПржХрзНрж╕ржЯрзЗржирж╢ржи ржирж╛ ржерж╛ржХрзЗ ржмрж╛ ржЦрзБржм рж▓ржорзНржмрж╛ рж╣рзЯ
             ext = '.mp4' # ржбрж┐ржлрж▓рзНржЯ
    except Exception:
        ext = '.mp4' # ржХрзЛржирзЛ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ ржбрж┐ржлрж▓рзНржЯ

    # ржкрж░рж┐ржЪрж┐ржд ржнрж┐ржбрж┐ржУ ржПржХрзНрж╕ржЯрзЗржирж╢ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
    if ext.lower() not in ['.mp4', '.ts', '.mkv', '.avi', '.mov', '.wmv', '.flv']:
         ext = '.mp4' # ржЕржЬрж╛ржирж╛ рж╣рж▓рзЗ mp4 ржзрж░рзБржи

    return f"video_{hashed_url}{ext}"

def download_video(url, output_filename):
    """ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзЗ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржлрж╛ржЗрж▓рзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗ"""
    filepath = os.path.join(VIDEO_DIR, output_filename)
    try:
        # ржпржжрж┐ ржлрж╛ржЗрж▓ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржерж╛ржХрзЗ ржПржмржВ ржПржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржирж╛ рж╣ржпрж╝, рждржмрзЗ ржЖржмрж╛рж░ ржбрж╛ржЙржирж▓рзЛржб ржирж╛ ржХрж░рж╛
        if os.path.exists(filepath) and output_filename != DEFAULT_VIDEO_FILENAME:
            # ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ ржЪрзЗржХ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ (ржЕржкрж╢ржирж╛рж▓)
            if os.path.getsize(filepath) > 0:
                 print(f"'{output_filename}' ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржЖржЫрзЗ ржПржмржВ ржЦрж╛рж▓рж┐ ржирзЯред")
                 return filepath
            else:
                 print(f"'{output_filename}' ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржЫрж┐рж▓ ржХрж┐ржирзНрждрзБ ржЦрж╛рж▓рж┐ред ржЖржмрж╛рж░ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред")

        # ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ рж╕ржмрж╕ржорзЯ ржЪрзЗржХ ржХрж░рж╛ ржмрж╛ ржирждрзБржи ржХрж░рзЗ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржнрж╛рж▓рзЛ рж╣рждрзЗ ржкрж╛рж░рзЗ ржпржжрж┐ ржПржЯрж┐ ржкрж░рж┐ржмрж░рзНрждржирж╢рзАрж▓ рж╣рзЯ
        # рждржмрзЗ ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ ржзрж░рзЗ ржирж┐ржЪрзНржЫрж┐ ржПржЯрж┐ рж╕рзНржерж┐рж░, рждрж╛ржЗ ржпржжрж┐ ржерж╛ржХрзЗ рждржмрзЗ ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржм

        print(f"ржбрж╛ржЙржирж▓рзЛржб рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ: {url} -> {filepath}")
        headers = {'User-Agent': 'Mozilla/5.0'} # ржХрж┐ржЫрзБ рж╕рж╛рж░рзНржнрж╛рж░рзЗрж░ ржЬржирзНржп User-Agent ржжрж░ржХрж╛рж░ рж╣рждрзЗ ржкрж╛рж░рзЗ
        response = requests.get(url, stream=True, timeout=30, headers=headers, allow_redirects=True) # рзйрзж рж╕рзЗржХрзЗржирзНржб ржЯрж╛ржЗржоржЖржЙржЯ, рж░рж┐ржбрж╛ржЗрж░рзЗржХрзНржЯ ржЕржирзБрж╕рж░ржг ржХрж░рзБржи
        response.raise_for_status()  # HTTP рждрзНрж░рзБржЯрж┐ ржерж╛ржХрж▓рзЗ Exception рждрзБрж▓ржмрзЗ

        # Content-Type ржЪрзЗржХ (ржЕржкрж╢ржирж╛рж▓)
        content_type = response.headers.get('content-type')
        if content_type and not content_type.startswith('video/') and not content_type.startswith('application/'):
             print(f"тЪая╕П рж╕рждрж░рзНржХрждрж╛: Content-Type '{content_type}' ржнрж┐ржбрж┐ржУ ржоржирзЗ рж╣ржЪрзНржЫрзЗ ржирж╛ ({url})")
             # ржЖржкржирж┐ ржПржЦрж╛ржирзЗ ржбрж╛ржЙржирж▓рзЛржб ржмрж╛рждрж┐рж▓ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи: return None

        with open(filepath, "wb") as f:
            downloaded_size = 0
            for chunk in response.iter_content(chunk_size=8192):
                if stop_event.is_set(): # ржбрж╛ржЙржирж▓рзЛржб ржЪрж▓рж╛ржХрж╛рж▓рзАржи ржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЪрзЗржХ
                    print("ржбрж╛ржЙржирж▓рзЛржб ржмрж╛рждрж┐рж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
                    if os.path.exists(filepath): os.remove(filepath) # ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
                    return None
                if chunk: # ржлрж┐рж▓рзНржЯрж╛рж░ ржЖржЙржЯ keep-alive new chunks
                    f.write(chunk)
                    downloaded_size += len(chunk)

        # ржбрж╛ржЙржирж▓рзЛржб рж╢рзЗрж╖рзЗ ржлрж╛ржЗрж▓ рж╕рж╛ржЗржЬ ржЪрзЗржХ
        if downloaded_size == 0:
             print(f"ржбрж╛ржЙржирж▓рзЛржб рж╕ржорзНржкржирзНржи рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирзНрждрзБ ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ рзж ({filepath})ред рж╕ржорзНржнржмржд рж╕ржорж╕рзНржпрж╛ ржЖржЫрзЗред")
             if os.path.exists(filepath): os.remove(filepath)
             return None

        print(f"рж╕ржлрж▓ржнрж╛ржмрзЗ ржбрж╛ржЙржирж▓рзЛржб рж╣рзЯрзЗржЫрзЗ: {output_filename} (Size: {downloaded_size / 1024:.2f} KB)")
        return filepath

    except requests.exceptions.Timeout:
        print(f"тЭМ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржЯрж╛ржЗржоржЖржЙржЯ ({url})")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None
    except requests.exceptions.RequestException as e:
        print(f"тЭМ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже ({url}): {e}")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None
    except Exception as e:
        print(f"тЭМ ржнрж┐ржбрж┐ржУ рж╕ржВрж░ржХрзНрж╖ржг ржмрж╛ ржЕржирзНржп ржХрзЛржирзЛ рждрзНрж░рзБржЯрж┐ ({url}): {e}")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None

# def create_single_video_playlist(video_path):
#     """FFmpeg рж╕рж░рж╛рж╕рж░рж┐ ржлрж╛ржЗрж▓ ржкрж╛рже ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, рждрж╛ржЗ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржЖрж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ"""
#     pass

def stop_ffmpeg_stream():
    """ржЪрж▓ржорж╛ржи FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржмржирзНржз ржХрж░рзЗ"""
    global current_ffmpeg_process
    # рж▓ржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржХрж╛рж░ржг ржЕрзНржпрж╛ржбржорж┐ржи рж░рзБржЯ ржерзЗржХрзЗржУ ржПржЯрж┐ ржХрж▓ рж╣рждрзЗ ржкрж╛рж░рзЗ (ржнржмрж┐рж╖рзНржпрждрзЗ)
    # ржПржмржВ ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржбржУ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ
    with stream_lock:
        process_to_stop = current_ffmpeg_process # ржПржХржЯрж┐ рж▓рзЛржХрж╛рж▓ ржнрзЗрж░рж┐рзЯрзЗржмрж▓рзЗ ржХржкрж┐ ржХрж░рзБржи
        if process_to_stop:
            print(f"FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржмржирзНржз ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ (PID: {process_to_stop.pid})...")
            if process_to_stop.poll() is None: # ржпржжрж┐ ржкрзНрж░рж╕рзЗрж╕ ржПржЦржиржУ ржЪрж╛рж▓рзБ ржерж╛ржХрзЗ
                try:
                    # ржкрзНрж░ржержорзЗ SIGTERM ржкрж╛ржарж┐рзЯрзЗ ржХрж┐ржЫрзБржЯрж╛ рж╕ржорзЯ ржжрзЗржУрзЯрж╛
                    process_to_stop.terminate()
                    process_to_stop.wait(timeout=5) # рзл рж╕рзЗржХрзЗржирзНржб ржЕржкрзЗржХрзНрж╖рж╛
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╕ржлрж▓ржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗржЫрзЗ (terminate)ред")
                except subprocess.TimeoutExpired:
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ terminate рж╣рзЯржирж┐, SIGKILL ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗ...")
                    # ржпржжрж┐ terminate ржХрж╛ржЬ ржирж╛ ржХрж░рзЗ, рждржмрзЗ ржЬрзЛрж░ ржХрж░рзЗ ржмржирзНржз ржХрж░рж╛ (SIGKILL)
                    process_to_stop.kill()
                    process_to_stop.wait() # kill ржХрж░рж╛рж░ ржкрж░ wait ржХрж░рждрзЗ рж╣ржмрзЗ рж░рж┐рж╕рзЛрж░рзНрж╕ ржорзБржХрзНржд ржХрж░рж╛рж░ ржЬржирзНржп
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╕ржлрж▓ржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗржЫрзЗ (kill)ред")
                except Exception as e:
                    # ProcessLookupError ржШржЯрждрзЗ ржкрж╛рж░рзЗ ржпржжрж┐ ржкрзНрж░рж╕рзЗрж╕ ржарж┐ржХ ржЖржЧрзЗржЗ рж╢рзЗрж╖ рж╣рзЯрзЗ ржпрж╛рзЯ
                    print(f"FFmpeg ржмржирзНржз ржХрж░рж╛рж░ рж╕ржорзЯ рждрзНрж░рзБржЯрж┐: {e}")
            else:
                print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржмржирзНржз ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛рж░ рж╕ржорзЯ ржжрзЗржЦрж╛ ржЧрзЗрж▓рзЛ ржПржЯрж┐ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржмржирзНржз ржЫрж┐рж▓ред")
            # ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж░рж┐рж╕рзЗржЯ ржХрж░рзБржи рж╢рзБржзрзБржорж╛рждрзНрж░ ржпржжрж┐ ржПржЯрж┐ рж╕рзЗржЗ ржкрзНрж░рж╕рзЗрж╕ржЗ рж╣ржпрж╝ ржпрж╛ ржЖржорж░рж╛ ржмржирзНржз ржХрж░рждрзЗ ржЪрзЗржпрж╝рзЗржЫрж┐рж▓рж╛ржо
            if current_ffmpeg_process == process_to_stop:
                 current_ffmpeg_process = None
                 # currently_playing_url ржПржЦрж╛ржирзЗ рж░рж┐рж╕рзЗржЯ ржХрж░рж╛ ржЙржЪрж┐ржд ржирж╛, ржХрж╛рж░ржг ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржПржЯрж┐ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рзЗ

def start_ffmpeg_stream(video_path, loop=False):
    """ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржнрж┐ржбрж┐ржУ ржлрж╛ржЗрж▓ ржерзЗржХрзЗ FFmpeg рж╕рзНржЯрзНрж░рж┐ржо рж╢рзБрж░рзБ ржХрж░рзЗ"""
    global current_ffmpeg_process

    # ржирждрзБржи рж╕рзНржЯрзНрж░рж┐ржо рж╢рзБрж░рзБ ржХрж░рж╛рж░ ржЖржЧрзЗ ржкрзБрж░ржирзЛржЯрж╛ ржмржирзНржз ржХрж░рзБржи (ржпржжрж┐ ржерж╛ржХрзЗ)
    # stop_ffmpeg_stream() # ржорзНржпрж╛ржирзЗржЬрж╛рж░ рж▓рзБржк ржерзЗржХрзЗ ржХрж▓ ржХрж░рж╛ржЗ ржнрж╛рж▓рзЛ

    abs_video_path = os.path.abspath(video_path)
    if not os.path.exists(abs_video_path):
        print(f"тЭМ FFmpeg рж╢рзБрж░рзБ ржХрж░рж╛ ржпрж╛ржЪрзНржЫрзЗ ржирж╛, ржлрж╛ржЗрж▓ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐: {abs_video_path}")
        return None

    ffmpeg_command_base = [
        'ffmpeg',
        '-re', # рж░рж┐ржпрж╝рзЗрж▓ ржЯрж╛ржЗржорзЗ ржЗржиржкрзБржЯ ржкрзЬрзБржи (рж▓рж╛ржЗржн рж╕рзНржЯрзНрж░рж┐ржорзЗрж░ ржЬржирзНржп ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг)
    ]

    # ржпржжрж┐ рж▓рзБржкрж┐ржВ ржжрж░ржХрж╛рж░ рж╣рзЯ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржЬржирзНржп)
    if loop:
        # -stream_loop -1 рж╕рж░рж╛рж╕рж░рж┐ ржЗржиржкрзБржЯрзЗрж░ ржЖржЧрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ
        ffmpeg_command_base.extend(['-stream_loop', '-1'])

    # ржЗржиржкрзБржЯ ржлрж╛ржЗрж▓ ржпрзЛржЧ ржХрж░рзБржи
    ffmpeg_command_base.extend(['-i', abs_video_path])

    # ржЖржЙржЯржкрзБржЯ ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ ржнрж╛рж▓рзЛ рж╣рждрзЗ ржкрж╛рж░рзЗ (рж╕рзЗржЧржорзЗржирзНржЯ ржХрзНрж▓рж┐ржиржЖржк)
    # ржПржЯрж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржпрзЗ ржкрзБрж░ржирзЛ рж╕рзЗржЧржорзЗржирзНржЯржЧрзБрж▓рзЛ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯрзЗ ржЖрж╕ржмрзЗ ржирж╛
    # for f in os.listdir(STREAM_OUTPUT_DIR):
    #     if f.endswith('.ts') or f.endswith('.m3u8'):
    #         os.remove(os.path.join(STREAM_OUTPUT_DIR, f))


    # ржмрж╛ржХрж┐ ржЕржкрж╢ржиржЧрзБрж▓рзЛ ржпрзЛржЧ ржХрж░рзБржи
    ffmpeg_command_options = [
        '-c:v', 'libx264',
        '-preset', 'veryfast', # CPU ржмрзНржпржмрж╣рж╛рж░ ржХржорж╛рзЯ, ржХрзЛрзЯрж╛рж▓рж┐ржЯрж┐ рж╕рж╛ржорж╛ржирзНржп ржХржорждрзЗ ржкрж╛рж░рзЗ
        '-tune', 'zerolatency', # рж▓рж╛ржЗржн рж╕рзНржЯрзНрж░рж┐ржорзЗрж░ ржЬржирзНржп рж▓рзНржпрж╛ржЯрзЗржирзНрж╕рж┐ ржХржорж╛ржирзЛрж░ ржЪрзЗрж╖рзНржЯрж╛
        '-b:v', '1500k', # ржнрж┐ржбрж┐ржУ ржмрж┐ржЯрж░рзЗржЯ (ржирзЗржЯржУрзЯрж╛рж░рзНржХ ржЕржирзБржпрж╛рзЯрзА ржкрж░рж┐ржмрж░рзНрждржирзАрзЯ)
        '-maxrate', '1500k', # рж╕рж░рзНржмрзЛржЪрзНржЪ ржмрж┐ржЯрж░рзЗржЯ
        '-bufsize', '3000k', # ржмрж╛ржлрж╛рж░ рж╕рж╛ржЗржЬ (ржмрж┐ржЯрж░рзЗржЯрзЗрж░ ржжрзНржмрж┐ржЧрзБржг)
        '-g', '60', # ржХрзАржлрзНрж░рзЗржо ржмрзНржпржмржзрж╛ржи (рзи рж╕рзЗржХрзЗржирзНржб @ рзйрзжfps)
        '-vf', 'scale=640:360', # ржЖржЙржЯржкрзБржЯ рж░рзЗржЬрзЛрж▓рж┐ржЙрж╢ржи (ржкрзНрж░рзЯрзЛржЬржирзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи)
        '-c:a', 'aac',         # ржЕржбрж┐ржУ ржХрзЛржбрзЗржХ
        '-b:a', '128k',        # ржЕржбрж┐ржУ ржмрж┐ржЯрж░рзЗржЯ
        '-ac', '2',            # рж╕рзНржЯрзЗрж░рж┐ржУ ржЕржбрж┐ржУ ржЪрзНржпрж╛ржирзЗрж▓
        '-ar', '44100',        # ржЕржбрж┐ржУ рж╕рзНржпрж╛ржорзНржкрзЗрж▓ рж░рзЗржЯ
        '-f', 'hls',           # ржЖржЙржЯржкрзБржЯ ржлрж░ржорзНржпрж╛ржЯ HLS
        '-hls_time', '4',      # ржкрзНрж░рждрж┐ржЯрж┐ рж╕рзЗржЧржорзЗржирзНржЯрзЗрж░ рж╕ржорзЯржХрж╛рж▓ (рж╕рзЗржХрзЗржирзНржб)
        '-hls_list_size', '5', # ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯрзЗ рж╕рзЗржЧржорзЗржирзНржЯрзЗрж░ рж╕ржВржЦрзНржпрж╛ (ржХржо рж╣рж▓рзЗ ржжрзНрж░рзБржд ржЖржкржбрзЗржЯ рж╣рзЯ)
        '-hls_flags', 'delete_segments+omit_endlist', # ржкрзБрж░ржирзЛ рж╕рзЗржЧржорзЗржирзНржЯ ржорзБржЫржмрзЗ ржПржмржВ рж▓рж╛ржЗржн ржжрзЗржЦрж╛ржмрзЗ (omit_endlist ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг)
        '-hls_segment_filename', os.path.join(STREAM_OUTPUT_DIR, 'segment%03d.ts'), # рж╕рзЗржЧржорзЗржирзНржЯ ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо ржкрзНржпрж╛ржЯрж╛рж░рзНржи
        HLS_OUTPUT_FILE        # ржорж╛рж╕рзНржЯрж╛рж░ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржлрж╛ржЗрж▓рзЗрж░ ржкрж╛рже
    ]

    ffmpeg_command = ffmpeg_command_base + ffmpeg_command_options

    print("ЁЯЪА FFmpeg ржХржорж╛ржирзНржб:", " ".join(ffmpeg_command))
    try:
        # stderr ржкрж╛ржЗржк ржХрж░рж╛ ржпрж╛рждрзЗ ржЖржорж░рж╛ ржПрж░рж░ ржмрж╛ ржУрзЯрж╛рж░рзНржирж┐ржВ ржжрзЗржЦрждрзЗ ржкрж╛рж░рж┐
        # stdout=subprocess.DEVNULL - ffmpeg ржПрж░ рж╕рзНржЯрзНржпрж╛ржирзНржбрж╛рж░рзНржб ржЖржЙржЯржкрзБржЯ ржмрзЗрж╢рж┐рж░ржнрж╛ржЧржЗ ржЕржкрзНрж░рзЯрзЛржЬржирзАрзЯ
        process = subprocess.Popen(ffmpeg_command, stdout=subprocess.DEVNULL, stderr=subprocess.PIPE)

        # stderr ржкрзЬрж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЫрзЛржЯ ржерзНрж░рзЗржб (ржбрж┐ржмрж╛ржЧрж┐ржВрзЯрзЗрж░ ржЬржирзНржп)
        def log_stderr(proc, path):
            if proc.stderr:
                for line in iter(proc.stderr.readline, b''):
                    if stop_event.is_set(): break
                    line_str = line.decode(errors='ignore').strip()
                    if line_str: # ржЦрж╛рж▓рж┐ рж▓рж╛ржЗржи ржкрзНрж░рж┐ржирзНржЯ ржирж╛ ржХрж░рж╛
                        print(f"  [FFmpeg stderr - {os.path.basename(path)}]: {line_str}")
            print(f"  [FFmpeg stderr рж░рж┐ржбрж┐ржВ рж╢рзЗрж╖ - {os.path.basename(path)}]")

        stderr_thread = threading.Thread(target=log_stderr, args=(process, video_path), daemon=True)
        stderr_thread.start()

        print(f"тЬЕ FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрзЗ (PID: {process.pid}) ржнрж┐ржбрж┐ржУ: {os.path.basename(video_path)}, рж▓рзБржк: {loop}")
        with stream_lock:
            current_ffmpeg_process = process # ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗ ржкрзНрж░рж╕рзЗрж╕ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи
        return process

    except FileNotFoundError:
        print(f"тЭМ рждрзНрж░рзБржЯрж┐: 'ffmpeg' ржХржорж╛ржирзНржб ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐ред FFmpeg ржЗржирж╕рзНржЯрж▓ ржХрж░рж╛ ржЖржЫрзЗ ржПржмржВ PATH ржП ржпрзЛржЧ ржХрж░рж╛ ржЖржЫрзЗ ржХрж┐ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржиред")
        with stream_lock:
             current_ffmpeg_process = None
        return None
    except Exception as e:
        print(f"тЭМ FFmpeg рж╢рзБрж░рзБ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже ({os.path.basename(video_path)}): {e}")
        with stream_lock:
            current_ffmpeg_process = None
        return None

# --- ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ (ржЖржкржбрзЗржЯрзЗржб рж▓ржЬрж┐ржХ рж╕рж╣) ---
def stream_manager():
    """
    ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржбрзЗ ржЪрж▓рзЗ, ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржПржмржВ FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗред
    рж╕рж░рзНржмржжрж╛ ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙржХрзЗ ржЕржЧрзНрж░рж╛ржзрж┐ржХрж╛рж░ ржжрзЗрзЯред ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржерж╛ржХрж▓рзЗржЗ ржХрзЗржмрж▓ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ рж▓рзБржк ржХрж░рзЗред
    ржХрж┐ржЙрждрзЗ ржирждрзБржи ржЖржЗржЯрзЗржо ржЖрж╕рж▓рзЗ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржмржирзНржз ржХрж░рзЗ ржжрзЗрзЯред
    """
    global currently_playing_url, default_video_path, current_ffmpeg_process

    # ржкрзНрж░ржержорзЗ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи (ржЕрзНржпрж╛ржк рж╢рзБрж░рзБрждрзЗ ржПржХржмрж╛рж░)
    print("тП│ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржЪрж▓ржЫрзЗ...")
    temp_default_path = download_video(DEFAULT_VIDEO_URL, DEFAULT_VIDEO_FILENAME)
    if temp_default_path:
         default_video_path = temp_default_path # рж╕ржлрж▓ рж╣рж▓рзЗ ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ рж╕рзЗржЯ ржХрж░рзБржи
         print(f"тЬЕ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржкрзНрж░рж╕рзНрждрзБржд: {default_video_path}")
    else:
         print("ЁЯЪи рж╕рждрж░рзНржХрждрж╛: ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржпрж╛рзЯржирж┐! ржбрж┐ржлрж▓рзНржЯ ржкрзНрж▓рзЗржмрзНржпрж╛ржХ ржХрж╛ржЬ ржХрж░ржмрзЗ ржирж╛ред")

    while not stop_event.is_set():
        next_video_path = None
        play_url = None
        loop_default = False
        stop_default_and_process_queue = False # ржбрж┐ржлрж▓рзНржЯ ржмржирзНржз ржХрж░рзЗ ржХрж┐ржЙ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рж╛рж░ ржлрзНрж▓рзНржпрж╛ржЧ

        try: # ржкрзБрж░рзЛ рж▓рзБржкржЯрж┐ try-except ржмрзНрж▓ржХрзЗ рж░рж╛ржЦрж╛ ржнрж╛рж▓рзЛ
            with stream_lock: # рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛ржЗржЬрзЗрж╢ржи ржЕржкрж░рж┐рж╣рж╛рж░рзНржп
                ffmpeg_is_running = current_ffmpeg_process and current_ffmpeg_process.poll() is None

                # --- ржзрж╛ржк рзз: ржпржжрж┐ FFmpeg ржЪрж▓рзЗ ---
                if ffmpeg_is_running:
                    # ржЪрзЗржХ ржХрж░рзБржи: ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ *ржПржмржВ* ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙрждрзЗ ржЖржЗржЯрзЗржо ржпрзЛржЧ рж╣рзЯрзЗржЫрзЗ?
                    if currently_playing_url == DEFAULT_VIDEO_URL and video_queue:
                        print("ЁЯФД ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрж┐рж▓, ржХрж┐ржирзНрждрзБ ржХрж┐ржЙрждрзЗ ржирждрзБржи ржЖржЗржЯрзЗржо ржПрж╕рзЗржЫрзЗред ржбрж┐ржлрж▓рзНржЯ ржмржирзНржз ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
                        stop_default_and_process_queue = True # ржлрзНрж▓рзНржпрж╛ржЧ рж╕рзЗржЯ ржХрж░рзБржи, рж▓ржХ ржЫрж╛рзЬрж╛рж░ ржкрж░ ржмржирзНржз ржХрж░рж╛ рж╣ржмрзЗ
                    else:
                        # ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ, ржЕржержмрж╛ ржбрж┐ржлрж▓рзНржЯ ржЪрж▓ржЫрзЗ ржХрж┐ржирзНрждрзБ ржХрж┐ржЙ ржПржЦржиржУ ржЦрж╛рж▓рж┐ред ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржиред
                        pass # time.sleep(1) ржПржЦрж╛ржирзЗ родрпЗро╡рпИропро┐ро▓рпНро▓рпИ, рж▓рзБржк ржжрзНрж░рзБржд ржЪрж▓ржмрзЗ

                # --- ржзрж╛ржк рзи: ржпржжрж┐ FFmpeg ржмржирзНржз ржерж╛ржХрзЗ ржмрж╛р╕Юр╕╢р╣Ир╕З рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗ ---
                else:
                    # ржпржжрж┐ ржкрзНрж░рж╕рзЗрж╕ рж╢рзЗрж╖ рж╣рзЯрзЗ ржерж╛ржХрзЗ, рждржмрзЗ рждрж╛ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рзБржи
                    if current_ffmpeg_process and current_ffmpeg_process.poll() is not None:
                        print(f"ЁЯПБ FFmpeg (PID: {current_ffmpeg_process.pid}) рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗред")
                        # ржкрзНрж▓рзЗ рж╣ржУрзЯрж╛ ржнрж┐ржбрж┐ржУржЯрж┐ржХрзЗ played_today рждрзЗ ржпрзЛржЧ ржХрж░рзБржи (ржпржжрж┐ ржПржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржирж╛ рж╣рзЯ)
                        if currently_playing_url and currently_playing_url != DEFAULT_VIDEO_URL:
                             played_today.add(currently_playing_url)
                        # рж░рж┐рж╕рзЛрж░рзНрж╕ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рзБржи
                        current_ffmpeg_process = None
                        currently_playing_url = None

                    # ржПржЦржи ржкрж░ржмрж░рзНрждрзА ржнрж┐ржбрж┐ржУ ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рзБржи (ржпрзЗрж╣рзЗрждрзБ FFmpeg ржЪрж▓ржЫрзЗ ржирж╛)
                    # --- ржЕржЧрзНрж░рж╛ржзрж┐ржХрж╛рж░: ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙ ---
                    if video_queue:
                        play_url = video_queue.popleft()
                        print(f"тЦ╢я╕П ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙ ржерзЗржХрзЗ ржирзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗ: {play_url[:80]}...") # URL ржЫрзЛржЯ ржХрж░рзЗ ржжрзЗржЦрж╛ржирзЛ
                        filename = get_safe_filename(play_url)
                        next_video_path = download_video(play_url, filename)
                        if not next_video_path:
                            print(f"тЭМ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже: {play_url[:80]}... ржкрж░ржмрж░рзНрждрзА ржЖржЗржЯрзЗржо ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржмрзЗред")
                            play_url = None # ржПржЯрж┐ ржкрзНрж▓рзЗ ржХрж░рж╛ ржпрж╛ржмрзЗ ржирж╛
                            # ржПржЦрж╛ржирзЗ continue ржирж╛ ржХрж░рзЗ рж▓рзБржкржЯрж┐ржХрзЗ рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХржнрж╛ржмрзЗ ржЪрж▓рждрзЗ ржжрзЗржУрзЯрж╛ ржнрж╛рж▓рзЛ
                        else:
                             # рж▓рзБржк рж╕рзЗржЯ ржХрж░ржмрзЗржи ржирж╛ ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ ржнрж┐ржбрж┐ржУрж░ ржЬржирзНржп
                             loop_default = False

                    # --- ржмрж┐ржХрж▓рзНржк: ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржпржжрж┐ ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржерж╛ржХрзЗ ржПржмржВ FFmpeg ржирж╛ ржЪрж▓рзЗ) ---
                    elif default_video_path:
                        print("тД╣я╕П ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙ ржЦрж╛рж▓рж┐ред ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржкрзНрж▓рзЗ ржХрж░рж╛ рж╣ржмрзЗ (рж▓рзБржк рж╕рж╣)ред")
                        next_video_path = default_video_path
                        play_url = DEFAULT_VIDEO_URL
                        loop_default = True # ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ рж▓рзБржк ржХрж░ржмрзЗ

                    # --- ржХрж┐ржЫрзБржЗ ржХрж░рж╛рж░ ржирзЗржЗ ---
                    else:
                        print("тП│ ржЕрзНржпрж╛ржбржорж┐ржи ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржПржмржВ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЙржкрж▓ржмрзНржз ржирзЗржЗред ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
                        pass # time.sleep(5) ржирж┐ржЪрзЗ рж╕рж░рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ

            # --- ржзрж╛ржк рзй: ржЕрзНржпрж╛ржХрж╢ржи (рж▓ржХрзЗрж░ ржмрж╛ржЗрж░рзЗ) ---

            # ржпржжрж┐ ржбрж┐ржлрж▓рзНржЯ рж╕рзНржЯрзНрж░рж┐ржо ржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржжрзНржзрж╛ржирзНржд ржирзЗржУрзЯрж╛ рж╣рзЯ
            if stop_default_and_process_queue:
                print("ЁЯЫС ржбрж┐ржлрж▓рзНржЯ рж╕рзНржЯрзНрж░рж┐ржо ржмржирзНржз ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
                stop_ffmpeg_stream()
                time.sleep(0.5) # FFmpeg ржмржирзНржз рж╣ржУрзЯрж╛рж░ ржЬржирзНржп рж╕рж╛ржорж╛ржирзНржп рж╕ржорзЯ ржжрж┐ржи
                continue # ржЕржмрж┐рж▓ржорзНржмрзЗ рж▓рзБржкржЯрж┐ ржкрзБржирж░рж╛рзЯ рж╢рзБрж░рзБ ржХрж░рзБржи ржпрж╛рждрзЗ ржХрж┐ржЙ ржерзЗржХрзЗ ржирждрзБржи ржЖржЗржЯрзЗржоржЯрж┐ ржирзЗржУрзЯрж╛ ржпрж╛рзЯ

            # ржпржжрж┐ ржкрзНрж▓рзЗ ржХрж░рж╛рж░ ржЬржирзНржп ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ
            if next_video_path and play_url:
                print(f" ba┼Яlat─▒l─▒yor... Video: {os.path.basename(next_video_path)}, D├╢ng├╝: {loop_default}")
                # currently_playing_url рж╕рзЗржЯ ржХрж░рж╛ ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг start_ffmpeg_stream ржПрж░ *ржЖржЧрзЗ*
                with stream_lock:
                     currently_playing_url = play_url
                # FFmpeg рж╢рзБрж░рзБ ржХрж░рзБржи
                started_process = start_ffmpeg_stream(next_video_path, loop=loop_default)
                if started_process:
                     time.sleep(2) # FFmpeg рж╢рзБрж░рзБ рж╣ржУрзЯрж╛рж░ ржЬржирзНржп ржПржХржЯрзБ рж╕ржорзЯ ржжрж┐ржи
                else:
                     # FFmpeg рж╢рзБрж░рзБ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже рж╣рж▓рзЗ, playing url рж░рж┐рж╕рзЗржЯ ржХрж░рзБржи
                     with stream_lock:
                         currently_playing_url = None
                     # рж╕ржорзНржнржмржд ржкрж░ржмрж░рзНрждрзА ржЗржЯрж╛рж░рзЗрж╢ржирзЗ ржЖржмрж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржмрзЗ

            # ржпржжрж┐ ржХрзЛржирзЛ ржЕрзНржпрж╛ржХрж╢ржи ржирж╛ ржирзЗржУрзЯрж╛ рж╣рзЯ (ржпрзЗржоржи ржХрж┐ржЙ ржЦрж╛рж▓рж┐, ржбрж┐ржлрж▓рзНржЯ ржирзЗржЗ, ржмрж╛ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже)
            elif not ffmpeg_is_running: # рж╢рзБржзрзБржорж╛рждрзНрж░ ржпржжрж┐ FFmpeg ржирж╛ ржЪрж▓рзЗ рждржмрзЗржЗ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи
                 time.sleep(3) # рзй рж╕рзЗржХрзЗржирзНржб ржкрж░ ржЖржмрж╛рж░ ржЪрзЗржХ ржХрж░рзБржи

            # ржпржжрж┐ FFmpeg ржЪрж▓рждрзЗ ржерж╛ржХрзЗ (ржПржмржВ ржПржЯрж┐ ржбрж┐ржлрж▓рзНржЯ ржирзЯ ржмрж╛ ржбрж┐ржлрж▓рзНржЯ ржХрж┐ржирзНрждрзБ ржХрж┐ржЙ ржЦрж╛рж▓рж┐), рждрж╛рж╣рж▓рзЗ ржЕрж▓рзНржк ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи
            elif ffmpeg_is_running:
                 time.sleep(1)


        except Exception as e:
             print(f"ЁЯЪи рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ рж▓рзБржкрзЗ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд рждрзНрж░рзБржЯрж┐: {e}")
             import traceback
             traceback.print_exc() # рж╕ржорзНржкрзВрж░рзНржг ржЯрзНрж░рзЗрж╕ржмрзНржпрж╛ржХ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзБржи
             time.sleep(5) # рждрзНрж░рзБржЯрж┐рж░ ржкрж░ ржХрж┐ржЫрзБржХрзНрж╖ржг ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи

    # --- ржерзНрж░рзЗржб ржмржирзНржз рж╣ржУрзЯрж╛рж░ рж╕ржорзЯ ---
    print("ЁЯЫС рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржмржирзНржз рж╣ржЪрзНржЫрзЗред")
    stop_ffmpeg_stream() # ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи FFmpeg ржмржирзНржз рж╣рзЯрзЗржЫрзЗ

# --- Flask Routes ---
@app.route('/')
def index():
    """ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ ржЬржирзНржп ржкрзНрж▓рзЗрзЯрж╛рж░ ржкрзЗржЬ рж░рзЗржирзНржбрж╛рж░ ржХрж░рзЗ"""
    return render_template('index.html')

@app.route('/admin')
def admin_panel():
    """ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ ржжрзЗржЦрж╛рзЯ"""
    with stream_lock: # ржбрзЗржЯрж╛ ржкрзЬрж╛рж░ рж╕ржорзЯржУ рж▓ржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржирж┐рж░рж╛ржкржж
        queue_snapshot = list(video_queue)
        played_snapshot = list(played_today)
        current_url_snapshot = currently_playing_url
        is_ffmpeg_running = current_ffmpeg_process and current_ffmpeg_process.poll() is None

    if is_ffmpeg_running:
        if current_url_snapshot == DEFAULT_VIDEO_URL:
            current_status = "ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ (рж▓рзБржк)"
        elif current_url_snapshot:
            current_status = f"ржЪрж▓ржЫрзЗ: {current_url_snapshot[:80]}..."
        else:
            current_status = "ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ (URL ржЕржЬрж╛ржирж╛)" # ржПржЯрж┐ рж╣ржУрзЯрж╛ ржЙржЪрж┐ржд ржирзЯ
    else:
        current_status = "ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ ржирж╛"

    return render_template('admin.html',
                           queue=queue_snapshot,
                           current_status=current_status,
                           played=played_snapshot)

@app.route('/admin/add', methods=['POST'])
def add_video():
    """ржХрж┐ржЙрждрзЗ ржирждрзБржи ржнрж┐ржбрж┐ржУ URL ржпрзЛржЧ ржХрж░рзЗ"""
    url = request.form.get('video_url')
    if url:
        # ржЦрзБржм рж╕рж╛ржзрж╛рж░ржг URL ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи
        if url.startswith('http://') or url.startswith('https://'):
            with stream_lock:
                video_queue.append(url)
                print(f"ЁЯУе ржХрж┐ржЙрждрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ: {url}")
                flash(f'"{url[:50]}..." рж╕ржлрж▓ржнрж╛ржмрзЗ ржХрж┐ржЙрждрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред', 'success')
            # ржХрзЛржирзЛ ржЕрзНржпрж╛ржХрж╢ржи ржирзЗржУрзЯрж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ, ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржирж┐ржЬрзЗ ржерзЗржХрзЗржЗ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░ржмрзЗ
            return redirect(url_for('admin_panel'))
        else:
            flash('ржЕржмрзИржз URL! ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ http:// ржмрж╛ https:// ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ рж╣ржУрзЯрж╛ ржПржХржЯрж┐ URL ржжрж┐ржиред', 'error')
    else:
        flash('URL ржЦрж╛рж▓рж┐ рж░рж╛ржЦрж╛ ржпрж╛ржмрзЗ ржирж╛ред', 'error')

    return redirect(url_for('admin_panel'))

@app.route('/admin/clear_queue', methods=['POST'])
def clear_queue():
    """ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржХрж░рзЗ"""
    with stream_lock:
        video_queue.clear()
        print("ЁЯЧСя╕П ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
        flash('ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред', 'success')
    return redirect(url_for('admin_panel'))

@app.route('/admin/clear_played', methods=['POST'])
def clear_played():
    """'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рзЗ"""
    with stream_lock:
        played_today.clear()
        print("ЁЯЧСя╕П 'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
        flash("'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред", 'success')
    return redirect(url_for('admin_panel'))


@app.route('/stream/<path:filename>')
def stream(filename):
    """HLS ржлрж╛ржЗрж▓ (.m3u8, .ts) рж╕рж╛рж░рзНржн ржХрж░рзЗ"""
    stream_abs_path = os.path.abspath(STREAM_OUTPUT_DIR)
    file_abs_path = os.path.abspath(os.path.join(stream_abs_path, filename))

    # ржкрж╛рже ржЯрзНрж░рзНржпрж╛ржнрж╛рж░рзНрж╕рж╛рж▓ ржЕрзНржпрж╛ржЯрж╛ржХ рж░рзЛржз ржХрж░рж╛
    if not file_abs_path.startswith(stream_abs_path):
        print(f"ЁЯЪл ржирж┐рж░рж╛ржкрждрзНрждрж╛ рж▓ржЩрзНржШржи ржкрзНрж░ржЪрзЗрж╖рзНржЯрж╛: {filename}")
        abort(404)

    # ржлрж╛ржЗрж▓ ржЖржЫрзЗ ржХрж┐ржирж╛ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
    if not os.path.exists(file_abs_path):
        # print(f"тЭУ ржлрж╛ржЗрж▓ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐: {file_abs_path}") # рж▓ржЧрж┐ржВ ржХржорж╛ржирзЛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ
        abort(404)

    # ржХрзНржпрж╛рж╢ ржХржирзНржЯрзНрж░рзЛрж▓ рж╣рзЗржбрж╛рж░ (рж▓рж╛ржЗржн рж╕рзНржЯрзНрж░рж┐ржорзЗрж░ ржЬржирзНржп ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг)
    response = send_from_directory(stream_abs_path, filename, conditional=True) # Conditional GET ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    # CORS рж╣рзЗржбрж╛рж░ (ржпржжрж┐ Flask-CORS ржпржерзЗрж╖рзНржЯ ржирж╛ рж╣рзЯ ржмрж╛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ рж░рзБржЯрзЗрж░ ржЬржирзНржп ржжрж░ржХрж╛рж░ рж╣рзЯ)
    # response.headers['Access-Control-Allow-Origin'] = '*'
    return response

# --- ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмржирзНржз ржХрж░рж╛рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
def signal_handler(sig, frame):
    print("\nЁЯЪж ржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржУрзЯрж╛ ржЧрзЗржЫрзЗ (Ctrl+C)...")
    stop_event.set() # рж╕ржм ржерзНрж░рзЗржбржХрзЗ ржмржирзНржз ржХрж░рж╛рж░ ржЬржирзНржп ржЗржнрзЗржирзНржЯ рж╕рзЗржЯ ржХрж░рзБржи
    print("тП│ FFmpeg ржПржмржВ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржерзНрж░рзЗржб ржмржирзНржз ржХрж░рж╛рж░ ржЬржирзНржп ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
    # ржПржЦрж╛ржирзЗ рж╕рж░рж╛рж╕рж░рж┐ stop_ffmpeg_stream() ржХрж▓ ржирж╛ ржХрж░рж╛ржЗ ржнрж╛рж▓рзЛ, ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржХрж░ржмрзЗ
    # рждржмрзЗ ржХрж┐ржЫрзБ рж╕ржорзЯ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ ржЙржЪрж┐ржд ржпрж╛рждрзЗ ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржХрж╛ржЬржЯрж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗ
    # manager_thread.join(timeout=10) # ржпржжрж┐ ржерзНрж░рзЗржб ржЕржмржЬрзЗржХрзНржЯ ржПржЦрж╛ржирзЗ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ржпрзЛржЧрзНржп рж╣рждрзЛ
    time.sleep(2) # ржкрзНрж░ржзрж╛ржи ржерзНрж░рзЗржбржХрзЗ ржХрж┐ржЫрзБржЯрж╛ рж╕ржорзЯ ржжрж┐ржи
    print("ЁЯСЛ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмржирзНржз рж╣ржЪрзНржЫрзЗред")
    os._exit(0) # ржлрзЛрж░рзНрж╕ ржПржХрзНрж╕рж┐ржЯ

# --- ржкрзНрж░ржзрж╛ржи ржЪрж╛рж▓ржХ ---
if __name__ == '__main__':
    print("ЁЯЪА ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ...")
    print(f"тП░ ржмрж░рзНрждржорж╛ржи рж╕ржорзЯ: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    # рж╕рж┐ржЧржирзНржпрж╛рж▓ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ рж╕рзЗржЯ ржХрж░рзБржи (Ctrl+C)
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    # ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб рж╢рзБрж░рзБ ржХрж░рзБржи
    manager_thread = threading.Thread(target=stream_manager, name="StreamManager", daemon=True)
    manager_thread.start()

    # Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рзБ ржХрж░рзБржи
    print(f"ЁЯМН Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рзБ рж╣ржЪрзНржЫрзЗ http://0.0.0.0:5000 ржП...")
    print(f"ЁЯФС ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓: http://127.0.0.1:5000/admin (ржЕржержмрж╛ ржЖржкржирж╛рж░ рж╕рж╛рж░рзНржнрж╛рж░ ржЖржЗржкрж┐)")
    # use_reloader=False ржжрзЗржУрзЯрж╛ ржЬрж░рзБрж░рж┐ ржпржЦржи ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржерзНрж░рзЗржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЗржи
    # threaded=True ржорж╛рж▓рзНржЯрж┐ржкрж▓ рж░рж┐ржХрзЛрзЯрзЗрж╕рзНржЯ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗ
    app.run(host='0.0.0.0', port=5000, threaded=True, use_reloader=False, debug=False) # Debug ржорзЛржб ржмржирзНржз рж░рж╛ржЦрзБржи ржкрзНрж░рзЛржбрж╛ржХрж╢ржирзЗ

    # ржПржЗ ржЕржВрж╢ржЯрж┐ рж╕рж╛ржзрж╛рж░ржгржд ржкрзМржБржЫрж╛ржмрзЗ ржирж╛ ржХрж╛рж░ржг app.run() ржмрзНрж▓ржХ ржХрж░рзЗ ржПржмржВ signal_handler ржкрзНрж░рж╕рзНржерж╛ржи ржХрж░рзЗ
    print("Flask ржЕрзНржпрж╛ржк рж╕рзНржмрж╛ржнрж╛ржмрж┐ржХржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗржЫрзЗред")
    stop_event.set()
    if manager_thread.is_alive():
        manager_thread.join(timeout=5)
    stop_ffmpeg_stream()
    print("ржкрзНрж░ржзрж╛ржи ржерзНрж░рзЗржб рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗред")
