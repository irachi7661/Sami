import os
import subprocess
import threading
import time
import signal
import requests
import hashlib
from flask import Flask, render_template, send_from_directory, abort, request, redirect, url_for, flash
from flask_cors import CORS
from collections import deque # ржнрж┐ржбрж┐ржУ ржХрж┐ржЙрзЯрзЗрж░ ржЬржирзНржп

# --- ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ---
DEFAULT_VIDEO_URL = "https://www.dropbox.com/scl/fi/kw2rpr2vsl7hf9gaddtsg/VID_20250330_041149_786.mp4?rlkey=rb347g41y8r0ekqvu3vea2znp&st=xtb6m8gx&raw=1"
DEFAULT_VIDEO_FILENAME = "default_video.ts" # ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржЬржирзНржп ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржирж╛ржо

VIDEO_DIR = "videos" # ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржнрж┐ржбрж┐ржУржЧрзБрж▓рзЛ ржПржЦрж╛ржирзЗ ржерж╛ржХржмрзЗ
STREAM_OUTPUT_DIR = "stream_output" # HLS ржЖржЙржЯржкрзБржЯ ржПржЦрж╛ржирзЗ рждрзИрж░рж┐ рж╣ржмрзЗ
FFMPEG_SINGLE_INPUT_FILE = "current_input.mp4" # FFmpeg ржПрж░ ржЗржиржкрзБржЯ рж╣рж┐рж╕рзЗржмрзЗ ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬржирзНржп ржлрж╛ржЗрж▓ (ржЕржержмрж╛ ржбрж╛ржЗржирж╛ржорж┐ржХрзНржпрж╛рж▓рж┐ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ)
FFMPEG_PLAYLIST_FILE = "playlist.txt" # рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУрж░ ржкрж╛рже ржерж╛ржХржмрзЗ ржПржЦрж╛ржирзЗ
HLS_OUTPUT_FILE = os.path.join(STREAM_OUTPUT_DIR, "stream.m3u8")

# ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐рзЯрзЗржмрж▓
video_queue = deque() # ржЕрзНржпрж╛ржбржорж┐ржи ржжрзНржмрж╛рж░рж╛ ржпрзЛржЧ ржХрж░рж╛ ржнрж┐ржбрж┐ржУ URL-ржПрж░ ржХрж┐ржЙ
played_today = set() # ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ ржнрж┐ржбрж┐ржУрж░ URL ржЯрзНрж░рзНржпрж╛ржХ ржХрж░рж╛рж░ ржЬржирзНржп (ржЕрзНржпрж╛ржк рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ рж╣рж▓рзЗ рж░рж┐рж╕рзЗржЯ рж╣ржмрзЗ)
current_ffmpeg_process = None
stop_event = threading.Event() # ржерзНрж░рзЗржб ржУ FFmpeg ржмржирзНржз ржХрж░рж╛рж░ ржЬржирзНржп
stream_lock = threading.Lock() # ржХрж┐ржЙ ржПржмржВ FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛ржЗржЬ ржХрж░рж╛рж░ ржЬржирзНржп
currently_playing_url = None # ржмрж░рзНрждржорж╛ржирзЗ ржХрзЛржи URL ржЯрж┐ ржкрзНрж▓рзЗ рж╣ржЪрзНржЫрзЗ ржмрж╛ ржкрзНрж▓рзЗ рж╣ржУрзЯрж╛рж░ ржЬржирзНржп ржкрзНрж░рж╕рзНрждрзБржд
default_video_path = None # ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржкрж╛рже

app = Flask(__name__)
CORS(app) # рж╕ржм рж░рзБржЯрзЗрж░ ржЬржирзНржп CORS рж╕ржХрзНрж░рж┐рзЯ ржХрж░рж╛
app.secret_key = os.urandom(24) # flash ржмрж╛рж░рзНрждрж╛рж░ ржЬржирзНржп Secret Key

# --- ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рждрзИрж░рж┐ ---
os.makedirs(VIDEO_DIR, exist_ok=True)
os.makedirs(STREAM_OUTPUT_DIR, exist_ok=True)

# --- Helper Functions ---

def get_safe_filename(url):
    """URL ржерзЗржХрзЗ ржПржХржЯрж┐ ржирж┐рж░рж╛ржкржж ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо рждрзИрж░рж┐ ржХрж░рзЗ (рж╣рзНржпрж╛рж╢ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)"""
    hashed_url = hashlib.sha1(url.encode()).hexdigest()[:10] # URL ржПрж░ рж╣рзНржпрж╛рж╢
    # ржлрж╛ржЗрж▓рзЗрж░ ржПржХрзНрж╕ржЯрзЗржирж╢ржи ржЕржирзБржорж╛ржи ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ (рж╕рж░рж▓ ржкржжрзНржзрждрж┐)
    if url.lower().endswith('.mp4'):
        ext = '.mp4'
    elif url.lower().endswith('.ts'):
        ext = '.ts'
    elif url.lower().endswith('.mkv'):
        ext = '.mkv'
    elif url.lower().endswith('.avi'):
        ext = '.avi'
    else:
        ext = '.mp4' # ржбрж┐ржлрж▓рзНржЯ ржПржХрзНрж╕ржЯрзЗржирж╢ржи
    return f"video_{hashed_url}{ext}"

def download_video(url, output_filename):
    """ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзЗ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржлрж╛ржЗрж▓рзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗ"""
    filepath = os.path.join(VIDEO_DIR, output_filename)
    try:
        # ржпржжрж┐ ржлрж╛ржЗрж▓ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржерж╛ржХрзЗ, ржЖржмрж╛рж░ ржбрж╛ржЙржирж▓рзЛржб ржирж╛ ржХрж░рж╛ (ржХрж┐ржирзНрждрзБ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ рж╕ржмрж╕ржорзЯ ржЪрзЗржХ ржХрж░рж╛ ржжрж░ржХрж╛рж░)
        if os.path.exists(filepath) and output_filename != DEFAULT_VIDEO_FILENAME:
            print(f"'{output_filename}' ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржЖржЫрзЗред")
            return filepath

        print(f"ржбрж╛ржЙржирж▓рзЛржб рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ: {url} -> {filepath}")
        response = requests.get(url, stream=True, timeout=30) # рзйрзж рж╕рзЗржХрзЗржирзНржб ржЯрж╛ржЗржоржЖржЙржЯ
        response.raise_for_status()  # HTTP рждрзНрж░рзБржЯрж┐ ржерж╛ржХрж▓рзЗ Exception рждрзБрж▓ржмрзЗ

        with open(filepath, "wb") as f:
            for chunk in response.iter_content(chunk_size=8192):
                if stop_event.is_set(): # ржбрж╛ржЙржирж▓рзЛржб ржЪрж▓рж╛ржХрж╛рж▓рзАржи ржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЪрзЗржХ
                    print("ржбрж╛ржЙржирж▓рзЛржб ржмрж╛рждрж┐рж▓ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
                    # ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ
                    if os.path.exists(filepath):
                        os.remove(filepath)
                    return None
                f.write(chunk)

        print(f"рж╕ржлрж▓ржнрж╛ржмрзЗ ржбрж╛ржЙржирж▓рзЛржб рж╣рзЯрзЗржЫрзЗ: {output_filename}")
        return filepath

    except requests.exceptions.Timeout:
        print(f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржЯрж╛ржЗржоржЖржЙржЯ ({url})")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None
    except requests.exceptions.RequestException as e:
        print(f"ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже ({url}): {e}")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None
    except Exception as e:
        print(f"ржнрж┐ржбрж┐ржУ рж╕ржВрж░ржХрзНрж╖ржг ржмрж╛ ржЕржирзНржп ржХрзЛржирзЛ рждрзНрж░рзБржЯрж┐ ({url}): {e}")
        if os.path.exists(filepath): os.remove(filepath) # ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржЖржВрж╢рж┐ржХ ржлрж╛ржЗрж▓ ржорзБржЫрзБржи
        return None

def create_single_video_playlist(video_path):
    """рж╢рзБржзрзБржорж╛рждрзНрж░ ржПржХржЯрж┐ ржнрж┐ржбрж┐ржУрж░ ржкрж╛рже ржжрж┐рзЯрзЗ playlist.txt рждрзИрж░рж┐ ржХрж░рзЗ"""
    abs_video_path = os.path.abspath(video_path)
    with open(FFMPEG_PLAYLIST_FILE, "w") as f:
        f.write(f"file '{abs_video_path}'\n")
    print(f"'{FFMPEG_PLAYLIST_FILE}' рждрзИрж░рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ: {abs_video_path}")

def stop_ffmpeg_stream():
    """ржЪрж▓ржорж╛ржи FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржмржирзНржз ржХрж░рзЗ"""
    global current_ffmpeg_process
    with stream_lock: # ржкрзНрж░рж╕рзЗрж╕ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ ржХрж░рж╛рж░ рж╕ржорзЯ рж▓ржХ ржХрж░рзБржи
        if current_ffmpeg_process:
            print(f"FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржмржирзНржз ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ (PID: {current_ffmpeg_process.pid})...")
            if current_ffmpeg_process.poll() is None: # ржпржжрж┐ ржкрзНрж░рж╕рзЗрж╕ ржПржЦржиржУ ржЪрж╛рж▓рзБ ржерж╛ржХрзЗ
                try:
                    # ржкрзНрж░ржержорзЗ SIGTERM ржкрж╛ржарж┐рзЯрзЗ ржХрж┐ржЫрзБржЯрж╛ рж╕ржорзЯ ржжрзЗржУрзЯрж╛
                    current_ffmpeg_process.terminate()
                    current_ffmpeg_process.wait(timeout=5) # рзл рж╕рзЗржХрзЗржирзНржб ржЕржкрзЗржХрзНрж╖рж╛
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╕ржлрж▓ржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗржЫрзЗ (terminate)ред")
                except subprocess.TimeoutExpired:
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ terminate рж╣рзЯржирж┐, SIGKILL ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗ...")
                    # ржпржжрж┐ terminate ржХрж╛ржЬ ржирж╛ ржХрж░рзЗ, рждржмрзЗ ржЬрзЛрж░ ржХрж░рзЗ ржмржирзНржз ржХрж░рж╛ (SIGKILL)
                    current_ffmpeg_process.kill()
                    current_ffmpeg_process.wait() # kill ржХрж░рж╛рж░ ржкрж░ wait ржХрж░рждрзЗ рж╣ржмрзЗ
                    print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╕ржлрж▓ржнрж╛ржмрзЗ ржмржирзНржз рж╣рзЯрзЗржЫрзЗ (kill)ред")
                except Exception as e:
                    print(f"FFmpeg ржмржирзНржз ржХрж░рж╛рж░ рж╕ржорзЯ рждрзНрж░рзБржЯрж┐: {e}")
            else:
                print("FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржЖржЧрзЗ ржерзЗржХрзЗржЗ ржмржирзНржз ржЫрж┐рж▓ред")
            current_ffmpeg_process = None # ржкрзНрж░рж╕рзЗрж╕ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ рж░рж┐рж╕рзЗржЯ ржХрж░рзБржи

def start_ffmpeg_stream(video_path, loop=False):
    """ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржнрж┐ржбрж┐ржУ ржлрж╛ржЗрж▓ ржерзЗржХрзЗ FFmpeg рж╕рзНржЯрзНрж░рж┐ржо рж╢рзБрж░рзБ ржХрж░рзЗ"""
    global current_ffmpeg_process

    stop_ffmpeg_stream() # ржирждрзБржи рж╕рзНржЯрзНрж░рж┐ржо рж╢рзБрж░рзБ ржХрж░рж╛рж░ ржЖржЧрзЗ ржкрзБрж░ржирзЛржЯрж╛ ржмржирзНржз ржХрж░рзБржи (ржпржжрж┐ ржерж╛ржХрзЗ)

    # create_single_video_playlist(video_path) # ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ рждрзИрж░рж┐ ржХрж░рзБржи

    ffmpeg_command_base = [
        'ffmpeg',
        '-re', # рж░рж┐ржпрж╝рзЗрж▓ ржЯрж╛ржЗржорзЗ ржЗржиржкрзБржЯ ржкрзЬрзБржи
    ]

    # ржпржжрж┐ рж▓рзБржкрж┐ржВ ржжрж░ржХрж╛рж░ рж╣рзЯ (рж╢рзБржзрзБржорж╛рждрзНрж░ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУрж░ ржЬржирзНржп)
    if loop:
        # -stream_loop -1 рж╕рж░рж╛рж╕рж░рж┐ ржЗржиржкрзБржЯрзЗрж░ ржЖржЧрзЗ ржжрж┐рждрзЗ рж╣ржмрзЗ
        ffmpeg_command_base.extend(['-stream_loop', '-1'])

    # ржЗржиржкрзБржЯ ржлрж╛ржЗрж▓ ржпрзЛржЧ ржХрж░рзБржи
    ffmpeg_command_base.extend(['-i', os.path.abspath(video_path)])

    # ржмрж╛ржХрж┐ ржЕржкрж╢ржиржЧрзБрж▓рзЛ ржпрзЛржЧ ржХрж░рзБржи
    ffmpeg_command_options = [
        '-c:v', 'libx264',
        '-preset', 'veryfast',
        '-b:v', '1500k', # ржнрж┐ржбрж┐ржУ ржмрж┐ржЯрж░рзЗржЯ
        '-maxrate', '1500k',
        '-bufsize', '3000k',
        '-g', '60', # ржХрзАржлрзНрж░рзЗржо ржмрзНржпржмржзрж╛ржи (рзи рж╕рзЗржХрзЗржирзНржб @ рзйрзжfps)
        '-vf', 'scale=640:360', # рж░рзЗржЬрзЛрж▓рж┐ржЙрж╢ржи рж╕рзЗржЯ ржХрж░рж╛ (ржпрзЗржоржи: 640x360)
        '-c:a', 'aac',
        '-b:a', '128k', # ржЕржбрж┐ржУ ржмрж┐ржЯрж░рзЗржЯ
        '-f', 'hls',
        '-hls_time', '4', # рж╕рзЗржЧржорзЗржирзНржЯ рж╕ржорзЯ (рж╕рзЗржХрзЗржирзНржб)
        '-hls_list_size', '5', # ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯрзЗ рж╕рзЗржЧржорзЗржирзНржЯ рж╕ржВржЦрзНржпрж╛
        '-hls_flags', 'delete_segments+omit_endlist', # ржкрзБрж░ржирзЛ рж╕рзЗржЧржорзЗржирзНржЯ ржорзБржЫржмрзЗ ржПржмржВ рж▓рж╛ржЗржн ржжрзЗржЦрж╛ржмрзЗ
        '-hls_segment_filename', os.path.join(STREAM_OUTPUT_DIR, 'segment%03d.ts'),
        HLS_OUTPUT_FILE
    ]

    ffmpeg_command = ffmpeg_command_base + ffmpeg_command_options

    print("FFmpeg ржХржорж╛ржирзНржб:", " ".join(ffmpeg_command))
    try:
        # DEVNULL ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ stdout рж╣рж╛ржЗржб ржХрж░рж╛, stderr ржкрж╛ржЗржк ржХрж░рж╛ ржпрж╛рждрзЗ ржЖржорж░рж╛ ржжрзЗржЦрждрзЗ ржкрж╛рж░рж┐
        process = subprocess.Popen(ffmpeg_command, stdout=subprocess.DEVNULL, stderr=subprocess.PIPE)

        # stderr ржкрзЬрж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржЫрзЛржЯ ржерзНрж░рзЗржб (ржЕржкрж╢ржирж╛рж▓, ржбрж┐ржмрж╛ржЧрж┐ржВрзЯрзЗрж░ ржЬржирзНржп)
        def log_stderr(proc):
            if proc.stderr:
                for line in iter(proc.stderr.readline, b''):
                    if stop_event.is_set(): break # ржпржжрж┐ ржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржЖрж╕рзЗ
                    print(f"FFmpeg stderr: {line.decode(errors='ignore').strip()}")
            print("FFmpeg stderr рж░рж┐ржбрж┐ржВ рж╢рзЗрж╖ред")

        stderr_thread = threading.Thread(target=log_stderr, args=(process,), daemon=True)
        stderr_thread.start()

        print(f"FFmpeg ржкрзНрж░рж╕рзЗрж╕ рж╢рзБрж░рзБ рж╣рзЯрзЗржЫрзЗ (PID: {process.pid}) ржнрж┐ржбрж┐ржУ: {video_path}, рж▓рзБржк: {loop}")
        with stream_lock:
            current_ffmpeg_process = process # ржЧрзНрж▓рзЛржмрж╛рж▓ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗ ржкрзНрж░рж╕рзЗрж╕ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзБржи
        return process # ржкрзНрж░рж╕рзЗрж╕ ржЕржмржЬрзЗржХрзНржЯ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзБржи

    except Exception as e:
        print(f"FFmpeg рж╢рзБрж░рзБ ржХрж░рждрзЗ ржмрзНржпрж░рзНрже ({video_path}): {e}")
        with stream_lock:
            current_ffmpeg_process = None
        return None

# --- ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ ---
def stream_manager():
    """
    ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржбрзЗ ржЪрж▓рзЗ, ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржПржмржВ FFmpeg ржкрзНрж░рж╕рзЗрж╕ ржорзНржпрж╛ржирзЗржЬ ржХрж░рзЗред
    ржХрж┐ржЙ ржерзЗржХрзЗ ржнрж┐ржбрж┐ржУ ржирж┐рзЯрзЗ ржкрзНрж▓рзЗ ржХрж░рзЗ, ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржерж╛ржХрж▓рзЗ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ рж▓рзБржк ржХрж░рзЗред
    """
    global currently_playing_url, default_video_path

    # ржкрзНрж░ржержорзЗ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи
    print("ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржЪрж▓ржЫрзЗ...")
    default_video_path = download_video(DEFAULT_VIDEO_URL, DEFAULT_VIDEO_FILENAME)
    if not default_video_path:
        print("ЁЯЪи рж╕рждрж░рзНржХрждрж╛: ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ ржпрж╛рзЯржирж┐! ржбрж┐ржлрж▓рзНржЯ ржкрзНрж▓рзЗржмрзНржпрж╛ржХ ржХрж╛ржЬ ржХрж░ржмрзЗ ржирж╛ред")

    while not stop_event.is_set():
        next_video_path = None
        play_url = None
        loop_default = False

        with stream_lock: # ржХрж┐ржЙ ржПржмржВ FFmpeg рж╕рзНржерж┐рждрж┐ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рж╛рж░ ржЬржирзНржп рж▓ржХ
            if current_ffmpeg_process and current_ffmpeg_process.poll() is None:
                # FFmpeg ржПржЦржиржУ ржЪрж▓ржЫрзЗ, ржХрж┐ржЫрзБ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗ
                time.sleep(1) # ржЕрж▓рзНржк рж╕ржорзЯ ржЕржкрзЗржХрзНрж╖рж╛
                continue # рж▓рзБржкрзЗрж░ ржкрж░ржмрж░рзНрждрзА ржЗржЯрж╛рж░рзЗрж╢ржирзЗ ржпрж╛ржи

            # FFmpeg ржЪрж▓ржЫрзЗ ржирж╛ ржмрж╛ рж╢рзЗрж╖ рж╣рзЯрзЗ ржЧрзЗржЫрзЗ
            if current_ffmpeg_process and current_ffmpeg_process.poll() is not None:
                 print(f"FFmpeg (PID: {current_ffmpeg_process.pid}) рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗред ржкрж░ржмрж░рзНрждрзА ржнрж┐ржбрж┐ржУ ржЦрзЛржБржЬрж╛ рж╣ржЪрзНржЫрзЗ...")
                 current_ffmpeg_process = None # ржкрзНрж░рж╕рзЗрж╕ рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗ, рж░рж┐рж╕рзЗржЯ ржХрж░рзБржи
                 # ржЖржЧрзЗрж░ ржнрж┐ржбрж┐ржУржЯрж┐ played_today рж╕рзЗржЯрзЗ ржпрзЛржЧ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ ржпржжрж┐ ржжрж░ржХрж╛рж░ рж╣рзЯ
                 if currently_playing_url and currently_playing_url != DEFAULT_VIDEO_URL:
                     played_today.add(currently_playing_url)
                 currently_playing_url = None


            # ржПржЦржи ржкрж░ржмрж░рзНрждрзА ржнрж┐ржбрж┐ржУ ржирж┐рж░рзНржзрж╛рж░ржг ржХрж░рзБржи
            if video_queue:
                play_url = video_queue.popleft() # ржХрж┐ржЙ ржерзЗржХрзЗ ржкрзНрж░ржержо URL ржЯрж┐ ржирж┐ржи
                print(f"ржХрж┐ржЙ ржерзЗржХрзЗ ржирзЗржУрзЯрж╛ рж╣рзЯрзЗржЫрзЗ: {play_url}")
                # ржПржЦрж╛ржирзЗ ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ played_today ржЪрзЗржХ ржХрж░рждрзЗ ржкрж╛рж░рзЗржи, ржпржжрж┐ржУ popleft ржХрж░рж╛ржЗ ржпржерзЗрж╖рзНржЯ
                # if play_url in played_today:
                #    print(f"'{play_url}' ржЖржЬржХрзЗ ржЗрждрж┐ржоржзрзНржпрзЗ ржкрзНрж▓рзЗ рж╣рзЯрзЗржЫрзЗ, рж╕рзНржХрж┐ржк ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред")
                #    play_url = None # ржПржЯрж┐ ржкрзНрж▓рзЗ ржХрж░ржмрзЗржирж╛, рж▓рзБржк ржЖржмрж╛рж░ ржЪрж▓ржмрзЗ
                #    continue # ржПржЗ ржЗржЯрж╛рж░рзЗрж╢ржи рж╕рзНржХрж┐ржк ржХрж░рзЗ ржкрж░рзЗрж░ржмрж╛рж░ ржЖржмрж╛рж░ ржЪрзЗржХ ржХрж░ржмрзЗ

                if play_url:
                    filename = get_safe_filename(play_url)
                    next_video_path = download_video(play_url, filename)
                    if not next_video_path:
                        print(f"ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже: {play_url}. ржкрж░ржмрж░рзНрждрзА ржнрж┐ржбрж┐ржУ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржмрзЗред")
                        play_url = None # ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже, ржПржЯрж┐ ржкрзНрж▓рзЗ рж╣ржмрзЗ ржирж╛
                        continue # рж▓рзБржкрзЗрж░ рж╢рзБрж░рзБрждрзЗ ржпрж╛ржи
            else:
                # ржХрж┐ржЙ ржЦрж╛рж▓рж┐, ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржкрзНрж▓рзЗ ржХрж░рзБржи (ржпржжрж┐ ржбрж╛ржЙржирж▓рзЛржб рж╣рзЯрзЗ ржерж╛ржХрзЗ)
                if default_video_path:
                    print("ржХрж┐ржЙ ржЦрж╛рж▓рж┐, ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржкрзНрж▓рзЗ ржХрж░рж╛ рж╣ржмрзЗ (рж▓рзБржк рж╕рж╣)ред")
                    next_video_path = default_video_path
                    play_url = DEFAULT_VIDEO_URL # ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рж╛рж░ ржЬржирзНржп ржпрзЗ ржбрж┐ржлрж▓рзНржЯ ржкрзНрж▓рзЗ рж╣ржЪрзНржЫрзЗ
                    loop_default = True
                else:
                    print("ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржПржмржВ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЙржкрж▓ржмрзНржз ржирзЗржЗред ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
                    # ржХрж┐ржЫрзБ ржХрж░рж╛рж░ ржирзЗржЗ, ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи
                    time.sleep(5)
                    continue # рж▓рзБржкрзЗрж░ рж╢рзБрж░рзБрждрзЗ ржпрж╛ржи

        # рж▓ржХ ржЫрзЗрзЬрзЗ ржжрзЗржУрзЯрж╛рж░ ржкрж░ FFmpeg ржЪрж╛рж▓рзБ ржХрж░рзБржи (ржпржжрж┐ ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ)
        if next_video_path and play_url:
            print(f"FFmpeg ржЪрж╛рж▓рзБ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ: {next_video_path}, рж▓рзБржк: {loop_default}")
            currently_playing_url = play_url # ржмрж░рзНрждржорж╛ржирзЗ ржкрзНрж▓рзЗ рж╣ржУрзЯрж╛ URL рж╕рзЗржЯ ржХрж░рзБржи
            start_ffmpeg_stream(next_video_path, loop=loop_default)
            time.sleep(2) # FFmpeg рж╢рзБрж░рзБ рж╣ржУрзЯрж╛рж░ ржЬржирзНржп ржПржХржЯрзБ рж╕ржорзЯ ржжрж┐ржи
        elif not video_queue and not default_video_path:
            # ржпржжрж┐ ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУ ржирж╛ ржерж╛ржХрзЗ (ржХрж┐ржЙ ржЦрж╛рж▓рж┐, ржбрж┐ржлрж▓рзНржЯ ржирзЗржЗ)
            time.sleep(5) # рзл рж╕рзЗржХрзЗржирзНржб ржкрж░ ржЖржмрж╛рж░ ржЪрзЗржХ ржХрж░рзБржи

    print("рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржмржирзНржз рж╣ржЪрзНржЫрзЗред")
    stop_ffmpeg_stream() # ржерзНрж░рзЗржб ржмржирзНржз рж╣ржУрзЯрж╛рж░ ржЖржЧрзЗ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи FFmpeg ржмржирзНржз рж╣рзЯрзЗржЫрзЗ

# --- Flask Routes ---
@app.route('/')
def index():
    """ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ ржЬржирзНржп ржкрзНрж▓рзЗрзЯрж╛рж░ ржкрзЗржЬ рж░рзЗржирзНржбрж╛рж░ ржХрж░рзЗ"""
    return render_template('index.html')

@app.route('/admin')
def admin_panel():
    """ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓ ржжрзЗржЦрж╛рзЯ"""
    # ржмрж░рзНрждржорж╛ржи ржХрж┐ржЙрзЯрзЗрж░ ржПржХржЯрж┐ ржХржкрж┐ ржкрж╛ржарж╛рждрзЗ рж╣ржмрзЗ ржпрж╛рждрзЗ рж░рзЗрж╕ ржХржирзНржбрж┐рж╢ржи ржПрзЬрж╛ржирзЛ ржпрж╛рзЯ
    with stream_lock:
        queue_snapshot = list(video_queue)
        current_status = currently_playing_url if current_ffmpeg_process and current_ffmpeg_process.poll() is None else "ржХрзЛржирзЛ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ ржирж╛ / ржбрж┐ржлрж▓рзНржЯ (ржпржжрж┐ ржерж╛ржХрзЗ)"
        if current_status == DEFAULT_VIDEO_URL:
             current_status = "ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрзЗ (рж▓рзБржк)"

    return render_template('admin.html', queue=queue_snapshot, current_status=current_status, played=list(played_today))

@app.route('/admin/add', methods=['POST'])
def add_video():
    """ржХрж┐ржЙрждрзЗ ржирждрзБржи ржнрж┐ржбрж┐ржУ URL ржпрзЛржЧ ржХрж░рзЗ"""
    url = request.form.get('video_url')
    if url:
        # ржЦрзБржм рж╕рж╛ржзрж╛рж░ржг URL ржнрзНржпрж╛рж▓рж┐ржбрзЗрж╢ржи (рж╢рзБржзрзБржорж╛рждрзНрж░ http/https ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ ржХрж┐ржирж╛)
        if url.startswith('http://') or url.startswith('https://'):
            with stream_lock:
                video_queue.append(url)
                print(f"ржХрж┐ржЙрждрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ: {url}")
                flash(f'"{url[:50]}..." рж╕ржлрж▓ржнрж╛ржмрзЗ ржХрж┐ржЙрждрзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред', 'success')

                # ржпржжрж┐ ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрж┐рж▓, рждржмрзЗ рж╕рзЗржЯрж┐ ржмржирзНржз ржХрж░рзЗ ржирждрзБржи ржнрж┐ржбрж┐ржУ рж╢рзБрж░рзБ ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ ржпрзЗрждрзЗ ржкрж╛рж░рзЗ
                # ржЕржержмрж╛ рж╢рзБржзрзБ ржХрж┐ржЙрждрзЗ ржпрзЛржЧ ржХрж░рж▓рзЗржЗ рж╣ржмрзЗ, ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░ржмрзЗ
                # ржЖржкрж╛рждржд, ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржбржХрзЗ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рждрзЗ ржжрзЗржУрзЯрж╛ ржпрж╛ржХ
                # if currently_playing_url == DEFAULT_VIDEO_URL and current_ffmpeg_process:
                #    print("ржбрж┐ржлрж▓рзНржЯ ржнрж┐ржбрж┐ржУ ржЪрж▓ржЫрж┐рж▓, ржирждрзБржи ржнрж┐ржбрж┐ржУ ржЖрж╕рж╛рзЯ ржмржирзНржз ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...")
                #    stop_ffmpeg_stream() # ржПржЯрж┐ ржХрж░рж▓рзЗ ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржкрж░рзЗрж░ ржЗржЯрж╛рж░рзЗрж╢ржирзЗ ржирждрзБржи ржнрж┐ржбрж┐ржУ ржзрж░ржмрзЗ

            # ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓рзЗ рж░рж┐ржбрж╛ржЗрж░рзЗржХрзНржЯ ржХрж░рзБржи
            return redirect(url_for('admin_panel'))
        else:
            flash('ржЕржмрзИржз URL! ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ http:// ржмрж╛ https:// ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ рж╣ржУрзЯрж╛ ржПржХржЯрж┐ URL ржжрж┐ржиред', 'error')
    else:
        flash('URL ржЦрж╛рж▓рж┐ рж░рж╛ржЦрж╛ ржпрж╛ржмрзЗ ржирж╛ред', 'error')

    return redirect(url_for('admin_panel'))

@app.route('/admin/clear_queue', methods=['POST'])
def clear_queue():
    """ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржХрж░рзЗ"""
    with stream_lock:
        video_queue.clear()
        print("ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
        flash('ржнрж┐ржбрж┐ржУ ржХрж┐ржЙ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред', 'success')
    return redirect(url_for('admin_panel'))

@app.route('/admin/clear_played', methods=['POST'])
def clear_played():
    """'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рзЗ"""
    with stream_lock:
        played_today.clear()
        print("'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред")
        flash("'ржЖржЬржХрзЗ ржЪрж╛рж▓рж╛ржирзЛ рж╣рзЯрзЗржЫрзЗ' рждрж╛рж▓рж┐ржХрж╛ ржЦрж╛рж▓рж┐ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗред", 'success')
    return redirect(url_for('admin_panel'))


@app.route('/stream/<path:filename>')
def stream(filename):
    """HLS ржлрж╛ржЗрж▓ (.m3u8, .ts) рж╕рж╛рж░рзНржн ржХрж░рзЗ"""
    # Security: Ensure the requested path is within the intended directory
    stream_abs_path = os.path.abspath(STREAM_OUTPUT_DIR)
    file_abs_path = os.path.abspath(os.path.join(stream_abs_path, filename))

    # ржкрж╛рже ржЯрзНрж░рзНржпрж╛ржнрж╛рж░рзНрж╕рж╛рж▓ ржЕрзНржпрж╛ржЯрж╛ржХ рж░рзЛржз ржХрж░рж╛
    if not file_abs_path.startswith(stream_abs_path):
        print(f"ржирж┐рж░рж╛ржкрждрзНрждрж╛ рж▓ржЩрзНржШржи ржкрзНрж░ржЪрзЗрж╖рзНржЯрж╛: {filename}")
        abort(404)

    # Ensure file exists before sending
    if not os.path.exists(file_abs_path):
        print(f"ржлрж╛ржЗрж▓ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐: {file_abs_path}")
        abort(404)

    # Cache Control Headers (optional but good for live streams)
    response = send_from_directory(stream_abs_path, filename)
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

# --- ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмржирзНржз ржХрж░рж╛рж░ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ ---
def signal_handler(sig, frame):
    print("\nржмржирзНржз ржХрж░рж╛рж░ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржУрзЯрж╛ ржЧрзЗржЫрзЗ (Ctrl+C)...")
    stop_event.set() # рж╕ржм ржерзНрж░рзЗржбржХрзЗ ржмржирзНржз ржХрж░рж╛рж░ ржЬржирзНржп ржЗржнрзЗржирзНржЯ рж╕рзЗржЯ ржХрж░рзБржи
    print("FFmpeg ржПржмржВ ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржерзНрж░рзЗржб ржмржирзНржз ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржЪрж▓ржЫрзЗ...")
    # stop_ffmpeg_stream() # ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб ржмржирзНржз рж╣ржУрзЯрж╛рж░ рж╕ржорзЯ ржПржЯрж┐ ржХрж▓ ржХрж░ржмрзЗ
    # ржПржЦрж╛ржирзЗ ржХрж┐ржЫрзБ рж╕ржорзЯ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ ржнрж╛рж▓рзЛ ржпрж╛рждрзЗ ржерзНрж░рзЗржб ржмржирзНржз рж╣рждрзЗ ржкрж╛рж░рзЗ
    time.sleep(1)
    print("ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмржирзНржз рж╣ржЪрзНржЫрзЗред")
    # ржкрзНрж░рж╕рзНржерж╛ржи ржХрж░рж╛рж░ ржПржХржЯрж┐ ржЙржкрж╛рзЯ, ржпржжрж┐ржУ ржПржЯрж┐ рж╕ржмрж╕ржорзЯ рж╕рзЗрж░рж╛ ржирзЯ ржлрзНрж▓рж╛рж╕рзНржХрзЗрж░ ржЬржирзНржп
    os._exit(0) # ржлрзЛрж░рзНрж╕ ржПржХрзНрж╕рж┐ржЯ, ржХрж╛рж░ржг ржлрзНрж▓рж╛рж╕рзНржХ рж╣рзЯрждрзЛ ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рждрзЗ ржкрж╛рж░рзЗ

# --- ржкрзНрж░ржзрж╛ржи ржЪрж╛рж▓ржХ ---
if __name__ == '__main__':
    print("ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ...")
    # рж╕рж┐ржЧржирзНржпрж╛рж▓ рж╣рзНржпрж╛ржирзНржбрж▓рж╛рж░ рж╕рзЗржЯ ржХрж░рзБржи (Ctrl+C)
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)

    # ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб рж╕рзНржЯрзНрж░рж┐ржо ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб рж╢рзБрж░рзБ ржХрж░рзБржи
    manager_thread = threading.Thread(target=stream_manager, daemon=True)
    manager_thread.start()

    # Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рзБ ржХрж░рзБржи
    print(f"Flask ржЕрзНржпрж╛ржк ржЪрж╛рж▓рзБ рж╣ржЪрзНржЫрзЗ http://0.0.0.0:5000 ржП...")
    print(f"ржЕрзНржпрж╛ржбржорж┐ржи ржкрзНржпрж╛ржирзЗрж▓: http://127.0.0.1:5000/admin (ржЕржержмрж╛ ржЖржкржирж╛рж░ рж╕рж╛рж░рзНржнрж╛рж░ ржЖржЗржкрж┐)")
    # use_reloader=False ржжрзЗржУрзЯрж╛ ржЬрж░рзБрж░рж┐ ржпржЦржи ржмрзНржпрж╛ржХржЧрзНрж░рж╛ржЙржирзНржб ржерзНрж░рзЗржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЗржи,
    # ржирж╛рж╣рж▓рзЗ ржлрзНрж▓рж╛рж╕рзНржХ ржжрзБржЯрж┐ ржкрзНрж░рж╕рзЗрж╕ рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░рзЗ ржПржмржВ ржЖржкржирж╛рж░ ржерзНрж░рзЗржб ржжрзБржЗржмрж╛рж░ ржЪрж▓рждрзЗ ржкрж╛рж░рзЗред
    app.run(host='0.0.0.0', port=5000, threaded=True, use_reloader=False)

    # ржПржЗ ржЕржВрж╢ржЯрж┐ рж╕рж╛ржзрж╛рж░ржгржд ржкрзМржБржЫрж╛ржмрзЗ ржирж╛ ржпржжрж┐ ржирж╛ run() ржХрзЛржирзЛ ржХрж╛рж░ржгрзЗ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ
    print("Flask ржЕрзНржпрж╛ржк ржмржирзНржз рж╣рзЯрзЗржЫрзЗред")
    stop_event.set() # ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи ржЗржнрзЗржирзНржЯ рж╕рзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ
    manager_thread.join(timeout=5) # ржорзНржпрж╛ржирзЗржЬрж╛рж░ ржерзНрж░рзЗржб рж╢рзЗрж╖ рж╣ржУрзЯрж╛рж░ ржЬржирзНржп ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи
    stop_ffmpeg_stream() # ржлрж╛ржЗржирж╛рж▓рж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи FFmpeg ржмржирзНржз
    print("ржкрзНрж░ржзрж╛ржи ржерзНрж░рзЗржб рж╢рзЗрж╖ рж╣рзЯрзЗржЫрзЗред")
